<!DOCTYPE html><html lang="en"><head><title>server</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="server"><meta name="groc-project-path" content="src/server.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/server.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="serveur-frontal-rest">Serveur frontal REST</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> bunyan <span class="hljs-keyword">from</span> <span class="hljs-string">'bunyan'</span>
<span class="hljs-keyword">import</span> chalk <span class="hljs-keyword">from</span> <span class="hljs-string">'chalk-template'</span>
<span class="hljs-keyword">import</span> restify <span class="hljs-keyword">from</span> <span class="hljs-string">'restify'</span>
<span class="hljs-keyword">import</span> restifyErrors <span class="hljs-keyword">from</span> <span class="hljs-string">'restify-errors'</span>

<span class="hljs-keyword">import</span> connection <span class="hljs-keyword">from</span> <span class="hljs-string">'./db/connection.js'</span>
<span class="hljs-keyword">import</span> { createServer } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.js'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Par défaut, notre serveur 100% REST ouvre sur le port 3000.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> PORT = <span class="hljs-built_in">Number</span>(process.env.PORT) || <span class="hljs-number">3000</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sans base, point de salut : on conditionne l’écoute HTTP à la bonne connexion
à la base MongoDB.</p></div></div><div class="code"><div class="wrapper">connection.on(<span class="hljs-string">'open'</span>, initServer)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="graceful-shutdown">Graceful shutdown</h2>
<p>Une fois le serveur lancé, on réagit avec ce gestionnaire au signal SIGTERM,
qui nous serait envoyé par l’environnement d’hébergement pours demander un
arrêt propre et rapide, par exemple dans le cadre d’une reconfiguration
élastique.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanUp</span>(<span class="hljs-params">server</span>) </span>{
  <span class="hljs-built_in">console</span>.log(chalk<span class="hljs-string">`{cyan <span class="hljs-subst">${server.name}</span> REST server shutting down…}`</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On commence par fermer la socket d’écoute, afin de ne plus accepter de
requête HTTP entrante ; on traite toujours celles déjà acceptées et en
cours.</p></div></div><div class="code"><div class="wrapper">  server.close(<span class="hljs-keyword">async</span> () =&gt; {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On peut ensuite attendre la fermeture de la connexion MongoDB ; idem,
celle-ci attendra que ses requêtes en cours soient terminées.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">await</span> connection.close()
    <span class="hljs-built_in">console</span>.log(chalk<span class="hljs-string">`{green <span class="hljs-subst">${server.name}</span> REST server shutdown complete}`</span>)
  })
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="lancement-du-serveur-http">Lancement du serveur HTTP</h2>
<p>C’est ici qu’on configure le serveur et qu’on active l’écoute HTTP.  Une fois
établi, il inscrit aussi le gestionnaire de <em>graceful shutdown</em> (qui n’a pas
d’utilité avant cela).</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initServer</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> server = createServer()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Log d’audit (grappes JSON détaillées), pratique en cas de besoin
diagnostic.</p></div></div><div class="code"><div class="wrapper">  server.on(
    <span class="hljs-string">'after'</span>,
    restify.plugins.auditLogger({
      log: bunyan.createLogger({
        name: <span class="hljs-string">'audit'</span>,
        serializers: { err: restifyErrors.bunyanSerializer },
        stream: process.stdout,
      }),
      event: <span class="hljs-string">'after'</span>,
    })
  )</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Et hop, écoute HTTP !</p></div></div><div class="code"><div class="wrapper">  server.listen(PORT, () =&gt; {
    <span class="hljs-built_in">console</span>.log(
      chalk<span class="hljs-string">`{green ✅  <span class="hljs-subst">${server.name}</span> REST server started at} {cyan.underline <span class="hljs-subst">${server.url}</span>}`</span>
    )
  })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Graceful shutdown</p></div></div><div class="code"><div class="wrapper">  process.on(<span class="hljs-string">'SIGTERM'</span>, () =&gt; cleanUp(server))
  process.on(<span class="hljs-string">'SIGINT'</span>, () =&gt; cleanUp(server))
}</div></div></div></div></body></html>