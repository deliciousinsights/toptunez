<!DOCTYPE html><html lang="en"><head><title>controllers/tunes</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="controllers/tunes"><meta name="groc-project-path" content="src/controllers/tunes.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/controllers/tunes.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="contrleur-rest-des-morceaux">Contrôleur REST des morceaux</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> errors <span class="hljs-keyword">from</span> <span class="hljs-string">'restify-errors'</span>
<span class="hljs-keyword">import</span> restify <span class="hljs-keyword">from</span> <span class="hljs-string">'restify'</span>
<span class="hljs-keyword">import</span> semver <span class="hljs-keyword">from</span> <span class="hljs-string">'semver'</span>

<span class="hljs-keyword">import</span> { requireAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'../util/middlewares.js'</span>
<span class="hljs-keyword">import</span> Tune <span class="hljs-keyword">from</span> <span class="hljs-string">'../db/Tune.js'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On va relâcher certaines validations de requêtes en mode tests, pour
faciliter ces derniers.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> TESTING = process.env.NODE_ENV === <span class="hljs-string">'test'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>L’API de requête/réponse de Restify ne permet pour le moment pas de remonter
vers le routeur en vigueur, on est donc réduits à récupérer une référence
quand on peut pour usage ultérieur…</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">let</span> router</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="configuration-des-routes">Configuration des routes</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cette fonction, l‘export par défaut du module, configure nos routes d’API
REST sur le serveur Restify fourni. Elle est appelée depuis la configuration
applicative de <code>src/app.js</code></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupTuneRoutes</span>(<span class="hljs-params">server</span>) </span>{
  router = server.router</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Route : listing des morceaux, potentiellement filtré par <em>query string</em></p></div></div><div class="code"><div class="wrapper">  server.get(
    {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Nommer nos routes nous permet par la suite, grâce au routeur et à sa
méthode <code>render()</code>, de reconstituer nos URLs automatiquement.</p></div></div><div class="code"><div class="wrapper">      name: <span class="hljs-string">'listTunes'</span>,
      path: <span class="hljs-string">'/tunes'</span>,
      validation: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Validation de la <em>query string</em></p></div></div><div class="code"><div class="wrapper">        queries: {
          filter: { isRequired: <span class="hljs-literal">false</span> },
          page: { isInt: <span class="hljs-literal">true</span>, isRequired: <span class="hljs-literal">false</span>, min: <span class="hljs-number">1</span> },
          pageSize: {
            isDivisibleBy: TESTING ? <span class="hljs-number">1</span> : <span class="hljs-number">10</span>,
            isInt: <span class="hljs-literal">true</span>,
            isRequired: <span class="hljs-literal">false</span>,
            min: TESTING ? <span class="hljs-number">1</span> : <span class="hljs-number">10</span>,
            max: <span class="hljs-number">100</span>,
          },
          sortBy: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Note : <code>flatMap</code> est ES2019, dispo depuis Node 11 (2018).</p></div></div><div class="code"><div class="wrapper">            isIn: [<span class="hljs-string">'album'</span>, <span class="hljs-string">'artist'</span>, <span class="hljs-string">'createdAt'</span>, <span class="hljs-string">'score'</span>, <span class="hljs-string">'title'</span>].flatMap(
              (field) =&gt; [field, <span class="hljs-string">`-<span class="hljs-subst">${field}</span>`</span>]
            ),
            isRequired: <span class="hljs-literal">false</span>,
          },
        },
      },
    },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On utilise ici un <code>conditionalHandler</code> pour pouvoir basculer d’un
gestionnaire à l’autre suivant la version d’API demandée (en-tête de
requête <code>Accept-Version</code>, syntaxe semver).  Ici en pratique le
gestionnaire est unique, mais grâce au plugin on bénéficiera :</p>
<ol>
<li>D’une méthode <code>version()</code> sur l’objet requête, qui indique la version
demandée.</li>
<li>D’un en-tête de réponse auto-rempli <code>api-version</code> qui retranscrit la
version exacte ayant fourni la réponse.</li>
</ol></div></div><div class="code"><div class="wrapper">    restify.plugins.conditionalHandler([
      { version: <span class="hljs-string">'1.0.0'</span>, handler: listTunes },
      { version: <span class="hljs-string">'1.2.0'</span>, handler: listTunes },
    ])
  )</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Route : création d’un morceau</p></div></div><div class="code"><div class="wrapper">  server.post(
    {
      name: <span class="hljs-string">'createTune'</span>,
      path: <span class="hljs-string">'/tunes'</span>,
      validation: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Validation du corps de requête</p></div></div><div class="code"><div class="wrapper">        content: {
          album: { isRequired: <span class="hljs-literal">false</span> },
          artist: { isRequired: <span class="hljs-literal">true</span> },
          title: { isRequired: <span class="hljs-literal">true</span> },
          url: { isRequired: <span class="hljs-literal">false</span>, isURL: <span class="hljs-literal">true</span> },
        },
      },
    },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Middleware à nous exigeant un utilisateur authentifié et doté du ou des
rôles éventuels indiqués. Voir <code>src/utils/middlewares.js</code>.</p></div></div><div class="code"><div class="wrapper">    requireAuth({ role: <span class="hljs-string">'admin'</span> }),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le gestionnaire à proprement parler arrive en dernier argument.</p></div></div><div class="code"><div class="wrapper">    createTune
  )</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Route : vote sur morceau</p></div></div><div class="code"><div class="wrapper">  server.post(
    {
      name: <span class="hljs-string">'voteOnTune'</span>,
      path: <span class="hljs-string">'/tunes/:tuneId/votes'</span>,
      validation: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Validation du corps de requête</p></div></div><div class="code"><div class="wrapper">        content: {
          comment: { isRequired: <span class="hljs-literal">false</span> },
          offset: { isInt: <span class="hljs-literal">true</span>, isIn: [-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>] },
        },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Validation des paramètres de l’URL (parties dynamiques du chemin)</p></div></div><div class="code"><div class="wrapper">        resources: {
          tuneId: { isRequired: <span class="hljs-literal">true</span>, isMongoId: <span class="hljs-literal">true</span> },
        },
      },
    },
    requireAuth(),
    voteOnTune
  )
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="gestionnaires-de-routes">Gestionnaires de routes</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Gestionnaire de route : création de morceau</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTune</span>(<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">const</span> { album, artist, title, url } = req.body
  <span class="hljs-keyword">const</span> tune = <span class="hljs-keyword">await</span> Tune.create({ album, artist, title, url })
  res.header(<span class="hljs-string">'X-Tune-ID'</span>, tune.id)
  res.send(<span class="hljs-number">201</span>)
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Gestionnaire de route : listing des morceaux</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listTunes</span>(<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">const</span> { filter, page, pageSize, sortBy } = req.query

  <span class="hljs-keyword">const</span> searchArgs = { filter, page, pageSize }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>res.header(&#39;api-version)</code> est présent en raison du <code>conditionalHandler</code>
qui entoure la configuration du gestionnaire.  Idée de la démo : seule
une demande de version explicitement 1.2+ permet la prise en compte du
filtre <code>sortBy</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (semver.gte(res.header(<span class="hljs-string">'api-version'</span>), <span class="hljs-string">'1.2.0'</span>)) {
    searchArgs.sorting = sortBy
  }
  <span class="hljs-keyword">const</span> { links, tunes } = <span class="hljs-keyword">await</span> Tune.search(searchArgs)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On passe de descripteurs de liens (ici des objets <code>{ page, pageSize }</code>) à
des URLs effectives, construites grâce à la fameuse méthode <code>render()</code> du
routeur.  Fournir ces liens est au cœur de HATEOAS.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [rel, query] <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.entries(links)) {
    <span class="hljs-keyword">const</span> url = router.render(<span class="hljs-string">'listTunes'</span>, {}, query)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remplacement des liens dans la grappe de données</p></div></div><div class="code"><div class="wrapper">    links[rel] = url</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Construction incrémentale de l’en-tête unique <code>Link:</code> de réponse</p></div></div><div class="code"><div class="wrapper">    res.link(url, rel)
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Renvoyer un objet bascule automatiquement le type de contenu réponse
<code>application/json</code> : inutile d‘utiliser explicitement <code>res.json()</code>.</p></div></div><div class="code"><div class="wrapper">  res.send({ links, tunes })
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Gestionnaire de route : vote sur morceau</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">voteOnTune</span>(<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">const</span> { tuneId } = req.params
  <span class="hljs-keyword">let</span> tune = <span class="hljs-keyword">await</span> Tune.findById(tuneId)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pas de morceau résultat ne constitue pas une exception en soi, et n’a
donc pas amené dans le <code>catch</code>. Mais on renvoie une 404, du coup.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (!tune) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> errors.ResourceNotFoundError(
      {
        info: { faultyId: tuneId },
      },
      <span class="hljs-string">'The tune you want to vote for cannot be found'</span>
    )
  }

  <span class="hljs-keyword">const</span> { comment, offset } = req.body</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On réaffecte ici car la mise à jour niveau Mongo ne se reflèterait pas
dans l’objet <code>tune</code> courant, donc <code>vote</code> nous en renvoie un nouveau.
D’où  une déclaration <code>let</code> et non <code>const</code> un peu plus haut.</p></div></div><div class="code"><div class="wrapper">  tune = <span class="hljs-keyword">await</span> tune.vote({ comment, offset })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Démo au passage de <code>noCache()</code>, qui cale tous les en-têtes de réponse
pour empêcher la mise en cache côté client, qu’on ne souhaite pas ici.</p></div></div><div class="code"><div class="wrapper">  res.noCache().send(<span class="hljs-number">201</span>, { score: tune.score, voteCount: tune.votes.length })
}</div></div></div></div></body></html>