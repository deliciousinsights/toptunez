<!DOCTYPE html><html lang="en"><head><title>db/connection</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="db/connection"><meta name="groc-project-path" content="src/db/connection.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/db/connection.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="connexion-mongodb">Connexion MongoDB</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> chalk <span class="hljs-keyword">from</span> <span class="hljs-string">'chalk-template'</span>
<span class="hljs-keyword">import</span> mongoose <span class="hljs-keyword">from</span> <span class="hljs-string">'mongoose'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="chane-url-de-connexion">Cha√Æne URL de connexion</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> url =</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Priorit√© absolue √† la globale explicite (environnement de test d√©di√© dans
JEST, plus important que la config √©ventuelle de dev / cloud).</p></div></div><div class="code"><div class="wrapper">  global.MONGODB_URI ||</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sinon, priorit√© √† la variable d‚Äôenvironnement (dotenv √©ventuel en dev,
clouds / h√©bergeurs)</p></div></div><div class="code"><div class="wrapper">  process.env.MONGODB_URI ||</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>En dernier recours, donc sous-entendu en dev sans dotenv, base Mongo
locale, non-authentifi√©e, sur le port par d√©faut.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-string">'mongodb://localhost:27017/toptunez'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="connexion-automatique">Connexion automatique</h2>
<p>Le simple fait de requ√©rir ce module active la connexion, ce qui est
notamment tr√®s pratique pour les tests, chaque mod√®le utilisant explicitement
ce module. Le param√®tre de <em>timeout</em> de connexion est ici sp√©cifiquement cal√©
pour le dev et les tests, mais ne pose pas de souci en production.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> connection = mongoose.createConnection(url, { connectTimeoutMS: <span class="hljs-number">5000</span> })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="logs-de-connexion--derreur">Logs de connexion / d‚Äôerreur</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">if</span> (process.env.NODE_ENV !== <span class="hljs-string">'test'</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Inutile de pourrir l‚Äôaffichage des tests avec le log de connexion √† la
base‚Ä¶</p></div></div><div class="code"><div class="wrapper">  connection.on(<span class="hljs-string">'open'</span>, () =&gt; {
    <span class="hljs-built_in">console</span>.log(
      chalk<span class="hljs-string">`{green ‚úÖ  Connected to mongoDB database <span class="hljs-subst">${connection.name}</span>}`</span>
    )
  })
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>En revanche, loguer une erreur de connexion est utile dans tous les cas !</p></div></div><div class="code"><div class="wrapper">connection.on(<span class="hljs-string">'error'</span>, () =&gt; {
  <span class="hljs-built_in">console</span>.error(
    chalk<span class="hljs-string">`{red üî•  Could not connect to mongoDB database <span class="hljs-subst">${connection.name}</span>}`</span>
  )
})</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Export par d√©faut du module : la connexion elle-m√™me.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connection</div></div></div></div></body></html>